# üóÑÔ∏è Supabase Backend - Complete Integration Guide

## ‚úÖ Current Status

Your Glow AI app **already has Supabase configured**! Here's what's set up:

### Existing Configuration
- **Supabase URL:** `https://sdaozejlnkzrkidxjylf.supabase.co`
- **Client File:** `src/lib/supabase.ts`
- **Basic Schema:** `src/db/schema.sql`
- **Existing Tables:**
  - ‚úÖ `profiles` - User profiles
  - ‚úÖ `scans` - Basic scan data
  - ‚úÖ `premium_activity` - Premium subscriptions

---

## üöÄ What You Need to Do

### Step 1: Run the Extended Schema

I've created a comprehensive database schema that supports **all AI features**. Here's how to apply it:

#### Option A: Via Supabase Dashboard (Recommended)

1. **Open Supabase Dashboard**
   - Go to: https://supabase.com/dashboard
   - Select your project: `sdaozejlnkzrkidxjylf`

2. **Navigate to SQL Editor**
   - Click "SQL Editor" in the left sidebar
   - Click "New Query"

3. **Run the Extended Schema**
   - Open file: `src/db/schema_extended.sql`
   - Copy the entire contents
   - Paste into the SQL Editor
   - Click "Run" or press `Ctrl+Enter`

4. **Verify Tables Created**
   - Go to "Table Editor" in sidebar
   - You should see 12 new/updated tables:
     - profiles (enhanced)
     - scans (enhanced)
     - scan_issues
     - routines
     - products
     - product_recommendations
     - cart
     - premium_activity
     - chat_history
     - progress_tracking
     - achievements
     - user_achievements

#### Option B: Via Supabase CLI

```bash
# Install Supabase CLI (if not installed)
npm install -g supabase

# Login to Supabase
supabase login

# Link to your project
supabase link --project-ref sdaozejlnkzrkidxjylf

# Run the migration
supabase db push
```

---

## üìä Database Schema Overview

### Core Tables

#### 1. **profiles** (Enhanced)
Stores user profile information with skin-specific data.

**New Fields Added:**
- `age` - User age for personalized recommendations
- `skin_type` - oily, dry, combination, normal, sensitive
- `skin_tone` - fair, medium, olive, brown, dark
- `gender` - For targeted recommendations
- `location` - Climate-based recommendations
- `updated_at` - Track profile changes

**Usage:**
```typescript
// Update user profile with skin info
const { data, error } = await supabase
  .from('profiles')
  .update({
    skin_type: 'combination',
    skin_tone: 'medium',
    age: 24,
    location: 'Mumbai'
  })
  .eq('id', userId);
```

---

#### 2. **scans** (Enhanced)
Stores AI skin analysis results.

**Structure:**
```typescript
{
  id: uuid,
  user_id: uuid,
  image_url: string,
  image_thumbnail_url: string,
  skin_score: number (0-100),
  analysis_status: 'pending' | 'processing' | 'completed' | 'failed',
  issues: [
    {
      name: "Acne & Breakouts",
      severity: 68,
      detected: true,
      confidence: 0.92
    }
  ],
  summary: "Your skin shows moderate acne...",
  recommendations: "Focus on salicylic acid...",
  ai_model_version: "gemini-pro-v1",
  processing_time_ms: 2340,
  created_at: timestamp
}
```

**Usage:**
```typescript
// Save scan result from AI
const { data, error } = await supabase
  .from('scans')
  .insert({
    user_id: userId,
    image_url: uploadedImageUrl,
    skin_score: 62,
    analysis_status: 'completed',
    issues: aiAnalysisResults.issues,
    summary: aiAnalysisResults.summary,
    ai_model_version: 'gemini-pro-v1'
  });
```

---

#### 3. **scan_issues** (New)
Detailed tracking of each skin issue with AI-generated remedies.

**Structure:**
```typescript
{
  id: uuid,
  scan_id: uuid,
  issue_type: 'acne' | 'dark_spots' | 'fine_lines' | ...,
  severity: number (0-100),
  confidence: number (0-1),
  remedy_title: "Clear Acne in 4 Weeks",
  remedy_description: "Follow this routine...",
  remedy_steps: [
    { step: 1, action: "Use salicylic acid cleanser", frequency: "twice daily" }
  ],
  expected_improvement_days: 28,
  recommended_ingredients: ["salicylic acid", "niacinamide"],
  ingredients_to_avoid: ["coconut oil", "heavy oils"]
}
```

**Usage:**
```typescript
// Get remedies for a scan
const { data: remedies } = await supabase
  .from('scan_issues')
  .select('*')
  .eq('scan_id', scanId)
  .eq('detected', true)
  .order('severity', { ascending: false });
```

---

#### 4. **routines** (New)
Personalized skincare routines generated by AI.

**Structure:**
```typescript
{
  id: uuid,
  user_id: uuid,
  scan_id: uuid,
  routine_type: 'morning' | 'evening' | 'weekly',
  title: "Morning Glow Routine",
  description: "Start your day with...",
  steps: [
    {
      order: 1,
      step: "Cleanser",
      product_type: "gentle cleanser",
      ingredients: ["salicylic acid"],
      duration: "30 seconds"
    },
    {
      order: 2,
      step: "Toner",
      product_type: "hydrating toner",
      ingredients: ["hyaluronic acid"],
      duration: "10 seconds"
    }
  ],
  is_active: true,
  season: 'summer' | 'winter' | 'monsoon' | 'all',
  difficulty: 'beginner' | 'intermediate' | 'advanced',
  estimated_time_minutes: 5
}
```

**Usage:**
```typescript
// Get user's active routines
const { data: routines } = await supabase
  .from('routines')
  .select('*')
  .eq('user_id', userId)
  .eq('is_active', true)
  .in('routine_type', ['morning', 'evening']);
```

---

#### 5. **products** (New)
Product catalog with ingredients and skin concern mapping.

**Structure:**
```typescript
{
  id: uuid,
  name: "Niacinamide 10% + Zinc 1% Serum",
  brand: "Minimalist",
  category: "serum",
  description: "Reduces acne, controls oil...",
  price: 599,
  currency: "INR",
  image_url: "https://...",
  ingredients: ["Niacinamide", "Zinc PCA", "Water"],
  key_ingredients: ["Niacinamide 10%", "Zinc 1%"],
  concerns: ["acne", "oiliness", "pores"],
  skin_types: ["oily", "combination"],
  rating: 4.5,
  reviews_count: 2847,
  affiliate_link: "https://amazon.in/...",
  availability: "in_stock",
  is_featured: true,
  is_verified: false
}
```

**Usage:**
```typescript
// Get products for specific concerns
const { data: products } = await supabase
  .from('products')
  .select('*')
  .contains('concerns', ['acne', 'oiliness'])
  .eq('availability', 'in_stock')
  .order('rating', { ascending: false });
```

---

#### 6. **product_recommendations** (New)
AI-matched products for each user based on their scan.

**Structure:**
```typescript
{
  id: uuid,
  user_id: uuid,
  scan_id: uuid,
  product_id: uuid,
  relevance_score: 0.92, // AI confidence
  reason: "This product contains salicylic acid which targets your acne concerns",
  matched_concerns: ["acne", "oiliness"],
  is_viewed: false,
  is_clicked: false,
  is_purchased: false
}
```

**Usage:**
```typescript
// Get recommended products for user's latest scan
const { data: recommendations } = await supabase
  .from('product_recommendations')
  .select(`
    *,
    products (*)
  `)
  .eq('user_id', userId)
  .eq('scan_id', latestScanId)
  .order('relevance_score', { ascending: false })
  .limit(10);
```

---

#### 7. **cart** (New)
Shopping cart for product purchases.

**Usage:**
```typescript
// Add product to cart
const { data, error } = await supabase
  .from('cart')
  .insert({
    user_id: userId,
    product_id: productId,
    quantity: 1
  });

// Get cart items
const { data: cartItems } = await supabase
  .from('cart')
  .select(`
    *,
    products (*)
  `)
  .eq('user_id', userId);
```

---

#### 8. **chat_history** (New)
AI assistant conversation history.

**Structure:**
```typescript
{
  id: uuid,
  user_id: uuid,
  role: 'user' | 'assistant',
  message: "How do I reduce acne?",
  scan_id: uuid, // Optional context
  context: { skin_score: 62, main_concerns: ["acne"] },
  ai_model: "gpt-4",
  tokens_used: 150
}
```

**Usage:**
```typescript
// Save chat message
await supabase.from('chat_history').insert({
  user_id: userId,
  role: 'user',
  message: userMessage
});

// Get conversation history
const { data: history } = await supabase
  .from('chat_history')
  .select('*')
  .eq('user_id', userId)
  .order('created_at', { ascending: true })
  .limit(50);
```

---

#### 9. **progress_tracking** (New)
Weekly/monthly analytics and trends.

**Usage:**
```typescript
// Get weekly progress
const { data: progress } = await supabase
  .from('progress_tracking')
  .select('*')
  .eq('user_id', userId)
  .eq('period_type', 'weekly')
  .order('period_start', { ascending: false })
  .limit(12); // Last 12 weeks
```

---

#### 10. **achievements** & **user_achievements** (New)
Gamification system.

**Usage:**
```typescript
// Get user's unlocked achievements
const { data: achievements } = await supabase
  .from('user_achievements')
  .select(`
    *,
    achievements (*)
  `)
  .eq('user_id', userId);
```

---

## üîê Row Level Security (RLS)

All tables have RLS policies configured to ensure users can only access their own data.

**Example Policies:**
- Users can only view/edit their own scans
- Users can only view/edit their own routines
- Products are publicly viewable
- Chat history is private to each user

**Testing RLS:**
```typescript
// This will only return scans for the authenticated user
const { data } = await supabase
  .from('scans')
  .select('*'); // RLS automatically filters by auth.uid()
```

---

## üìù Sample Queries for Your App

### Get User's Latest Skin Score
```typescript
const { data: latestScan } = await supabase
  .from('scans')
  .select('skin_score, created_at')
  .eq('user_id', userId)
  .order('created_at', { ascending: false })
  .limit(1)
  .single();
```

### Get Weekly Progress Chart Data
```typescript
const { data: weeklyScores } = await supabase
  .from('scans')
  .select('skin_score, created_at')
  .eq('user_id', userId)
  .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString())
  .order('created_at', { ascending: true });
```

### Get Active Morning Routine
```typescript
const { data: morningRoutine } = await supabase
  .from('routines')
  .select('*')
  .eq('user_id', userId)
  .eq('routine_type', 'morning')
  .eq('is_active', true)
  .single();
```

### Get Recommended Products
```typescript
const { data: recommendations } = await supabase
  .from('product_recommendations')
  .select(`
    relevance_score,
    reason,
    products (
      id,
      name,
      brand,
      price,
      image_url,
      rating
    )
  `)
  .eq('user_id', userId)
  .order('relevance_score', { ascending: false })
  .limit(5);
```

---

## üîÑ Integration with React Native App

### Update Context Files

You'll need to update your context files to use Supabase instead of mock data.

#### Example: HistoryContext.tsx

**Before (Mock Data):**
```typescript
const mockScans = [
  { id: '1', score: 65, date: Date.now() }
];
setScanHistory(mockScans);
```

**After (Supabase):**
```typescript
import { supabase } from '../lib/supabase';

const loadScanHistory = async () => {
  const { data, error } = await supabase
    .from('scans')
    .select('id, skin_score, created_at, issues')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  
  if (data) {
    setScanHistory(data);
  }
};

useEffect(() => {
  loadScanHistory();
}, [userId]);
```

#### Example: ProductContext.tsx

**Before (Mock Data):**
```typescript
const mockProducts = [/* hardcoded products */];
```

**After (Supabase):**
```typescript
const loadProducts = async () => {
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .eq('availability', 'in_stock')
    .order('is_featured', { ascending: false });
  
  if (data) {
    setProducts(data);
  }
};
```

---

## üñºÔ∏è Image Upload to Supabase Storage

For storing scan images, use Supabase Storage:

```typescript
import { supabase } from '../lib/supabase';

async function uploadScanImage(imageUri: string, userId: string) {
  // Convert image to blob
  const response = await fetch(imageUri);
  const blob = await response.blob();
  
  // Generate unique filename
  const filename = `${userId}/${Date.now()}.jpg`;
  
  // Upload to Supabase Storage
  const { data, error } = await supabase.storage
    .from('scan-images')
    .upload(filename, blob, {
      contentType: 'image/jpeg',
      cacheControl: '3600'
    });
  
  if (error) throw error;
  
  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('scan-images')
    .getPublicUrl(filename);
  
  return publicUrl;
}
```

**Setup Storage Bucket:**
1. Go to Supabase Dashboard ‚Üí Storage
2. Create new bucket: `scan-images`
3. Set as public or private (recommend private with signed URLs)

---

## üîë Environment Variables

Create `.env` file in your project root:

```env
# Supabase (Already configured)
SUPABASE_URL=https://sdaozejlnkzrkidxjylf.supabase.co
SUPABASE_ANON_KEY=sb_publishable_-QPUnBiXj0c1hHACmVs8Dw_uOwaKJoy

# AI APIs (You need to add these)
OPENAI_API_KEY=your_openai_key_here
GOOGLE_GEMINI_API_KEY=your_gemini_key_here

# Payment Gateway (Optional)
RAZORPAY_KEY_ID=your_razorpay_key
RAZORPAY_KEY_SECRET=your_razorpay_secret
```

---

## üìä Database Monitoring

### Check Table Sizes
```sql
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### Check Row Counts
```sql
SELECT 
  'scans' as table_name, 
  COUNT(*) as row_count 
FROM scans
UNION ALL
SELECT 'products', COUNT(*) FROM products
UNION ALL
SELECT 'routines', COUNT(*) FROM routines;
```

---

## üö® Important Notes

1. **RLS is Enabled**: All queries automatically filter by authenticated user
2. **Indexes Created**: Performance optimized for common queries
3. **Sample Data**: 3 Indian skincare products pre-loaded for testing
4. **Storage**: Set up `scan-images` bucket for image uploads
5. **Migrations**: Keep `schema_extended.sql` for future reference

---

## ‚úÖ Next Steps

1. ‚úÖ Run `schema_extended.sql` in Supabase dashboard
2. ‚úÖ Create `scan-images` storage bucket
3. ‚úÖ Update Context files to use Supabase
4. ‚úÖ Test queries in Supabase dashboard
5. ‚úÖ Integrate AI APIs (see AI_FEATURES_TODO.md)

---

**Your backend is ready! Now you just need to connect the AI APIs.** üöÄ
